{{- if index .Values "global" }}
{{- if (index (index .Values "global") "installCRD") }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: skyfloais.skyflo.ai
  labels:
    {{- include "skyflo.labels" . | nindent 4 }}
spec:
  group: skyflo.ai
  names:
    kind: SkyfloAI
    listKind: SkyfloAIList
    plural: skyfloais
    singular: skyfloai
    shortNames:
    - sky
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required: [ui, engine, mcp]
            properties:
              ui:
                type: object
                required: [image]
                properties:
                  image: { type: string }
                  replicas: { type: integer, minimum: 1 }
                  resources: { type: object }
                  env: { type: array, items: { type: object, required: [name], properties: { name: { type: string }, value: { type: string } } } }
              engine:
                type: object
                required: [image]
                properties:
                  image: { type: string }
                  replicas: { type: integer, minimum: 1 }
                  resources: { type: object }
                  databaseConfig: { type: object, properties: { host: { type: string }, port: { type: integer }, database: { type: string }, secretName: { type: string } } }
                  redisConfig: { type: object, properties: { host: { type: string }, port: { type: integer }, secretName: { type: string } } }
                  env: { type: array, items: { type: object, required: [name], properties: { name: { type: string }, value: { type: string } } } }
              mcp:
                type: object
                required: [image]
                properties:
                  image: { type: string }
                  replicas: { type: integer, minimum: 1 }
                  resources: { type: object }
                  kubeconfigSecret: { type: string }
                  env: { type: array, items: { type: object, required: [name], properties: { name: { type: string }, value: { type: string } } } }
              imagePullSecrets: { type: array }
              nodeSelector: { type: object }
              tolerations: { type: array }
              affinity: { type: object }
          status:
            type: object
            properties:
              uiStatus: { type: object, properties: { phase: { type: string }, message: { type: string }, readyReplicas: { type: integer }, desiredReplicas: { type: integer } } }
              engineStatus: { type: object, properties: { phase: { type: string }, message: { type: string }, readyReplicas: { type: integer }, desiredReplicas: { type: integer } } }
              conditions: { type: array }
    additionalPrinterColumns:
    - name: UI Ready
      type: string
      jsonPath: .status.uiStatus.phase
    - name: Engine Ready
      type: string
      jsonPath: .status.engineStatus.phase
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    subresources:
      status: {}
{{- end }}
{{- end }}
